{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\User\\\\Desktop\\\\\\u96F2\\u6E67\\u667A\\u751F\\\\happysing_aws\\\\frontend\\\\src\\\\pages\\\\Generator.tsx\",\n  _s = $RefreshSig$();\nimport React, { useState, useEffect, useRef } from 'react';\nimport { useLocation, useNavigate } from 'react-router-dom';\nimport './Home.css'; // Import gradient styles\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n// 定义选择工具类型\nvar SelectionTool = /*#__PURE__*/function (SelectionTool) {\n  SelectionTool[\"RECTANGLE\"] = \"rectangle\";\n  SelectionTool[\"LASSO\"] = \"lasso\";\n  SelectionTool[\"NONE\"] = \"none\";\n  return SelectionTool;\n}(SelectionTool || {}); // 定义选择区域的接口\nasync function callPromptBooster(promptText) {\n  try {\n    const response = await fetch('https://409etc6v1f.execute-api.us-west-2.amazonaws.com/promptbooster', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({\n        user_prompt: promptText,\n        inspiration_image_ids: [],\n        use_trends: true\n      })\n    });\n    const data = await response.json();\n    console.log('[DEBUG] API Response:', data); // 便於調試 API 響應\n\n    const boostedPrompt = data.boosted_prompt; // 直接獲取 boosted_prompt，不需要 JSON.parse(data.body)\n\n    return boostedPrompt;\n  } catch (error) {\n    console.log('Prompt booster API failed, using fallback enhancement:', error);\n\n    // 失敗時的備用方案\n    const enhancedPrompt = `${promptText}\\n\\n額外考慮要點：\n- 散熱效能最佳化\n- 材質選擇與工藝品質\n- 噪音控制\n- 安裝便利性\n- 美觀設計\n- 兼容性與未來擴充`;\n    return enhancedPrompt;\n  }\n}\nasync function callImageGenerator(promptText, userId, roundId) {\n  try {\n    const response = await fetch('https://409etc6v1f.execute-api.us-west-2.amazonaws.com/imagegenerator', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({\n        prompt: promptText,\n        user_id: userId,\n        generation_round: roundId\n      })\n    });\n    const data = await response.json();\n    return data.generated_images; // <-- array of image URLs\n  } catch (error) {\n    console.error('Image generation failed:', error);\n    return []; // fallback\n  }\n}\nconst Generator = () => {\n  _s();\n  const location = useLocation();\n  const navigate = useNavigate();\n  const state = location.state;\n  const [isGenerating, setIsGenerating] = useState(false);\n  const [refinedPrompt, setRefinedPrompt] = useState('');\n  const [loading, setLoading] = useState(true);\n  const [selectedImage, setSelectedImage] = useState('');\n  const [showMindmapButton, setShowMindmapButton] = useState(false);\n\n  // Canvas相关状态\n  const canvasRef = useRef(null);\n  const imageRef = useRef(null);\n  const [activeTool, setActiveTool] = useState(SelectionTool.NONE);\n  const [isSelecting, setIsSelecting] = useState(false);\n  const [selectionArea, setSelectionArea] = useState(null);\n  const [startPoint, setStartPoint] = useState(null);\n  const [lassoPoints, setLassoPoints] = useState([]);\n  const [editingPrompt, setEditingPrompt] = useState('');\n  const [isProcessing, setIsProcessing] = useState(false);\n\n  // 獲取用戶上傳的圖片\n  const baseImage = (state === null || state === void 0 ? void 0 : state.baseImage) || null;\n  const referenceImage = (state === null || state === void 0 ? void 0 : state.referenceImage) || null;\n\n  // Mock images for demonstration\n  const mockImages = ['/assets/design1.jpg', '/assets/design1.jpg', '/assets/design1.jpg'];\n  useEffect(() => {\n    if (!(state !== null && state !== void 0 && state.prompt)) {\n      const storedState = localStorage.getItem('generator-last-state');\n      if (storedState) {\n        try {\n          const parsedState = JSON.parse(storedState);\n          if (parsedState && parsedState.prompt) {\n            console.log('Restored state from localStorage:', parsedState);\n            navigate(location.pathname, {\n              state: parsedState,\n              replace: true\n            });\n            return;\n          }\n        } catch (error) {\n          console.error('Error restoring state from localStorage:', error);\n        }\n      }\n      console.log('No valid state found, redirecting to home');\n      navigate('/');\n      return;\n    }\n    try {\n      localStorage.setItem('generator-last-state', JSON.stringify(state));\n    } catch (error) {\n      console.error('Error saving state to localStorage:', error);\n    }\n\n    // 設置原始提示詞\n    if (state.boostedPrompt) {\n      setRefinedPrompt(state.boostedPrompt);\n    } else {\n      // 如果沒有已經優化的提示詞，則使用原始提示詞\n      setRefinedPrompt(state.prompt);\n    }\n    setLoading(false);\n    setShowMindmapButton(true);\n  }, [state, navigate, location.pathname]);\n\n  // 选择图片后加载到Canvas\n  useEffect(() => {\n    if (selectedImage && canvasRef.current) {\n      loadImageToCanvas(selectedImage);\n    }\n  }, [selectedImage]);\n\n  // 加载图片到Canvas\n  const loadImageToCanvas = src => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n    const ctx = canvas.getContext('2d');\n    if (!ctx) return;\n    const img = new Image();\n    img.crossOrigin = 'anonymous';\n    img.onload = () => {\n      // 设置Canvas尺寸与图片一致\n      canvas.width = img.width;\n      canvas.height = img.height;\n\n      // 清除Canvas并绘制图片\n      ctx.clearRect(0, 0, canvas.width, canvas.height);\n      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);\n\n      // 保存图片引用\n      imageRef.current = img;\n    };\n    img.src = src;\n  };\n  const handleImageSelect = imageUrl => {\n    setSelectedImage(imageUrl);\n    // 重置选区\n    setSelectionArea(null);\n    setActiveTool(SelectionTool.NONE);\n  };\n  const handleBackToPrompt = () => {\n    // Navigate back to the appropriate product page based on the product type\n    if (state !== null && state !== void 0 && state.productType) {\n      navigate(`/${state.productType}`);\n    } else {\n      navigate('/');\n    }\n  };\n  const handleViewMindmap = () => {\n    navigate('/mindmap', {\n      state: {\n        productType: (state === null || state === void 0 ? void 0 : state.productType) || 'cooler',\n        initialPrompt: state === null || state === void 0 ? void 0 : state.prompt\n      }\n    });\n  };\n\n  // Canvas 鼠标事件处理\n  const handleMouseDown = e => {\n    if (activeTool === SelectionTool.NONE || !canvasRef.current) return;\n    setIsSelecting(true);\n    const canvas = canvasRef.current;\n    const rect = canvas.getBoundingClientRect();\n    const x = e.clientX - rect.left;\n    const y = e.clientY - rect.top;\n    setStartPoint({\n      x,\n      y\n    });\n    if (activeTool === SelectionTool.LASSO) {\n      setLassoPoints([{\n        x,\n        y\n      }]);\n    }\n  };\n  const handleMouseMove = e => {\n    if (!isSelecting || !canvasRef.current || !startPoint) return;\n    const canvas = canvasRef.current;\n    const rect = canvas.getBoundingClientRect();\n    const x = e.clientX - rect.left;\n    const y = e.clientY - rect.top;\n    if (activeTool === SelectionTool.RECTANGLE) {\n      drawSelectionPreview({\n        x: startPoint.x,\n        y: startPoint.y,\n        width: x - startPoint.x,\n        height: y - startPoint.y,\n        type: SelectionTool.RECTANGLE\n      });\n    } else if (activeTool === SelectionTool.LASSO) {\n      const newPoints = [...lassoPoints, {\n        x,\n        y\n      }];\n      setLassoPoints(newPoints);\n      drawLassoPreview(newPoints);\n    }\n  };\n  const handleMouseUp = e => {\n    if (!isSelecting || !canvasRef.current || !startPoint) return;\n    setIsSelecting(false);\n    const canvas = canvasRef.current;\n    const rect = canvas.getBoundingClientRect();\n    const x = e.clientX - rect.left;\n    const y = e.clientY - rect.top;\n    if (activeTool === SelectionTool.RECTANGLE) {\n      setSelectionArea({\n        x: startPoint.x,\n        y: startPoint.y,\n        width: x - startPoint.x,\n        height: y - startPoint.y,\n        type: SelectionTool.RECTANGLE\n      });\n    } else if (activeTool === SelectionTool.LASSO && lassoPoints.length > 2) {\n      // 闭合套索\n      const closedPoints = [...lassoPoints, lassoPoints[0]];\n      setLassoPoints(closedPoints);\n      setSelectionArea({\n        x: Math.min(...closedPoints.map(p => p.x)),\n        y: Math.min(...closedPoints.map(p => p.y)),\n        points: closedPoints,\n        type: SelectionTool.LASSO\n      });\n    }\n    redrawCanvas();\n  };\n\n  // 绘制矩形选择预览\n  const drawSelectionPreview = selection => {\n    const canvas = canvasRef.current;\n    if (!canvas || !selection.width || !selection.height) return;\n    const ctx = canvas.getContext('2d');\n    if (!ctx) return;\n\n    // 重绘原图\n    redrawCanvas();\n\n    // 绘制选择矩形\n    ctx.strokeStyle = '#ff0000';\n    ctx.lineWidth = 2;\n    ctx.setLineDash([5, 5]);\n    ctx.strokeRect(selection.x, selection.y, selection.width, selection.height);\n\n    // 创建半透明遮罩\n    ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';\n    ctx.fillRect(selection.x, selection.y, selection.width, selection.height);\n  };\n\n  // 绘制套索选择预览\n  const drawLassoPreview = points => {\n    const canvas = canvasRef.current;\n    if (!canvas || points.length < 2) return;\n    const ctx = canvas.getContext('2d');\n    if (!ctx) return;\n\n    // 重绘原图\n    redrawCanvas();\n\n    // 绘制套索路径\n    ctx.beginPath();\n    ctx.moveTo(points[0].x, points[0].y);\n    for (let i = 1; i < points.length; i++) {\n      ctx.lineTo(points[i].x, points[i].y);\n    }\n    ctx.strokeStyle = '#ff0000';\n    ctx.lineWidth = 2;\n    ctx.setLineDash([5, 5]);\n    ctx.stroke();\n\n    // 如果点足够多，填充半透明遮罩\n    if (points.length > 2) {\n      ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';\n      ctx.fill();\n    }\n  };\n\n  // 重绘Canvas\n  const redrawCanvas = () => {\n    const canvas = canvasRef.current;\n    const img = imageRef.current;\n    if (!canvas || !img) return;\n    const ctx = canvas.getContext('2d');\n    if (!ctx) return;\n\n    // 清除画布\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\n\n    // 绘制图片\n    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);\n\n    // 绘制当前选区\n    if (selectionArea) {\n      if (selectionArea.type === SelectionTool.RECTANGLE && selectionArea.width && selectionArea.height) {\n        ctx.strokeStyle = '#ff0000';\n        ctx.lineWidth = 2;\n        ctx.setLineDash([5, 5]);\n        ctx.strokeRect(selectionArea.x, selectionArea.y, selectionArea.width, selectionArea.height);\n        ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';\n        ctx.fillRect(selectionArea.x, selectionArea.y, selectionArea.width, selectionArea.height);\n      } else if (selectionArea.type === SelectionTool.LASSO && selectionArea.points && selectionArea.points.length > 2) {\n        ctx.beginPath();\n        ctx.moveTo(selectionArea.points[0].x, selectionArea.points[0].y);\n        for (let i = 1; i < selectionArea.points.length; i++) {\n          ctx.lineTo(selectionArea.points[i].x, selectionArea.points[i].y);\n        }\n        ctx.strokeStyle = '#ff0000';\n        ctx.lineWidth = 2;\n        ctx.setLineDash([5, 5]);\n        ctx.stroke();\n        ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';\n        ctx.fill();\n      }\n    }\n  };\n\n  // 取消选择\n  const cancelSelection = () => {\n    setSelectionArea(null);\n    setActiveTool(SelectionTool.NONE);\n    redrawCanvas();\n  };\n\n  // 获取选区图像数据\n  const getSelectionImageData = () => {\n    const canvas = canvasRef.current;\n    if (!canvas || !selectionArea) return null;\n    const ctx = canvas.getContext('2d');\n    if (!ctx) return null;\n    if (selectionArea.type === SelectionTool.RECTANGLE && selectionArea.width && selectionArea.height) {\n      // 获取矩形区域的图像数据\n      return ctx.getImageData(selectionArea.x, selectionArea.y, selectionArea.width, selectionArea.height);\n    } else if (selectionArea.type === SelectionTool.LASSO && selectionArea.points && selectionArea.points.length > 2) {\n      // 对于套索，我们需要创建一个临时画布\n      const tempCanvas = document.createElement('canvas');\n      const tempCtx = tempCanvas.getContext('2d');\n      if (!tempCtx) return null;\n\n      // 计算包围盒\n      const minX = Math.min(...selectionArea.points.map(p => p.x));\n      const minY = Math.min(...selectionArea.points.map(p => p.y));\n      const maxX = Math.max(...selectionArea.points.map(p => p.x));\n      const maxY = Math.max(...selectionArea.points.map(p => p.y));\n      const width = maxX - minX;\n      const height = maxY - minY;\n      tempCanvas.width = width;\n      tempCanvas.height = height;\n\n      // 创建套索形状\n      tempCtx.beginPath();\n      tempCtx.moveTo(selectionArea.points[0].x - minX, selectionArea.points[0].y - minY);\n      for (let i = 1; i < selectionArea.points.length; i++) {\n        tempCtx.lineTo(selectionArea.points[i].x - minX, selectionArea.points[i].y - minY);\n      }\n\n      // 裁剪\n      tempCtx.closePath();\n      tempCtx.clip();\n\n      // 绘制原图的选区部分\n      tempCtx.drawImage(canvas, minX, minY, width, height,\n      // 源矩形\n      0, 0, width, height // 目标矩形\n      );\n\n      // 获取图像数据\n      return tempCtx.getImageData(0, 0, width, height);\n    }\n    return null;\n  };\n\n  // 处理编辑操作\n  const handleEdit = async () => {\n    if (!selectionArea || !editingPrompt.trim()) return;\n    setIsProcessing(true);\n\n    // 获取选区图像数据\n    const imageData = getSelectionImageData();\n    if (!imageData) {\n      setIsProcessing(false);\n      return;\n    }\n\n    // 将图像数据转为 Base64\n    const tempCanvas = document.createElement('canvas');\n    tempCanvas.width = imageData.width;\n    tempCanvas.height = imageData.height;\n    const tempCtx = tempCanvas.getContext('2d');\n    if (!tempCtx) {\n      setIsProcessing(false);\n      return;\n    }\n    tempCtx.putImageData(imageData, 0, 0);\n    const base64Image = tempCanvas.toDataURL('image/png');\n    try {\n      // 模拟AI处理\n      console.log(`处理图像编辑，提示词：\"${editingPrompt}\"`);\n      console.log('选区信息:', selectionArea);\n      console.log('图像数据宽度:', imageData.width, '高度:', imageData.height);\n\n      // 模拟API调用\n      await new Promise(resolve => setTimeout(resolve, 2000));\n\n      // 在实际应用中，这里会向后端API发送请求\n      // const response = await fetch('/api/edit-image', {\n      //   method: 'POST',\n      //   headers: { 'Content-Type': 'application/json' },\n      //   body: JSON.stringify({\n      //     image: base64Image,\n      //     prompt: editingPrompt,\n      //     selectionType: selectionArea.type\n      //   })\n      // });\n      // const result = await response.json();\n      // const editedImageBase64 = result.editedImage;\n\n      // 假设这是处理后的图像结果(模拟)\n      // 为了演示，我们在这里简单修改原图像数据（增加亮度）\n      const editedImageData = simpleImageEdit(imageData);\n\n      // 应用编辑后的图像\n      applyEditedImage(editedImageData);\n\n      // 清除选区\n      setSelectionArea(null);\n      setEditingPrompt('');\n      alert('图像编辑完成！');\n    } catch (error) {\n      console.error('图像编辑失败:', error);\n      alert('图像编辑失败，请重试');\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  // 简单的图像编辑模拟（增加亮度）\n  const simpleImageEdit = imageData => {\n    const data = imageData.data.slice();\n\n    // 增加亮度（简单处理）\n    for (let i = 0; i < data.length; i += 4) {\n      data[i] = Math.min(255, data[i] + 50); // R\n      data[i + 1] = Math.min(255, data[i + 1] + 50); // G\n      data[i + 2] = Math.min(255, data[i + 2] + 50); // B\n    }\n    const newImageData = new ImageData(new Uint8ClampedArray(data), imageData.width, imageData.height);\n    return newImageData;\n  };\n\n  // 将编辑后的图像应用到原画布\n  const applyEditedImage = editedImageData => {\n    const canvas = canvasRef.current;\n    if (!canvas || !selectionArea) return;\n    const ctx = canvas.getContext('2d');\n    if (!ctx) return;\n    if (selectionArea.type === SelectionTool.RECTANGLE && selectionArea.width && selectionArea.height) {\n      // 直接将编辑后的图像数据放回原位置\n      ctx.putImageData(editedImageData, selectionArea.x, selectionArea.y);\n    } else if (selectionArea.type === SelectionTool.LASSO && selectionArea.points && selectionArea.points.length > 2) {\n      // 对于套索，需要使用临时画布\n      const minX = Math.min(...selectionArea.points.map(p => p.x));\n      const minY = Math.min(...selectionArea.points.map(p => p.y));\n      const tempCanvas = document.createElement('canvas');\n      tempCanvas.width = editedImageData.width;\n      tempCanvas.height = editedImageData.height;\n      const tempCtx = tempCanvas.getContext('2d');\n      if (!tempCtx) return;\n\n      // 放置编辑后的图像数据\n      tempCtx.putImageData(editedImageData, 0, 0);\n\n      // 保存当前画布状态\n      ctx.save();\n\n      // 创建剪切路径\n      ctx.beginPath();\n      ctx.moveTo(selectionArea.points[0].x, selectionArea.points[0].y);\n      for (let i = 1; i < selectionArea.points.length; i++) {\n        ctx.lineTo(selectionArea.points[i].x, selectionArea.points[i].y);\n      }\n      ctx.closePath();\n      ctx.clip();\n\n      // 绘制编辑后的图像\n      ctx.drawImage(tempCanvas, 0, 0, tempCanvas.width, tempCanvas.height, minX, minY, tempCanvas.width, tempCanvas.height);\n\n      // 恢复画布状态\n      ctx.restore();\n    }\n\n    // 更新当前图像\n    updateCurrentImage();\n  };\n\n  // 更新当前图像引用\n  const updateCurrentImage = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n    const img = new Image();\n    img.src = canvas.toDataURL('image/png');\n    img.onload = () => {\n      imageRef.current = img;\n    };\n  };\n\n  // 處理繼續按鈕點擊\n  const handleContinue = async () => {\n    setIsGenerating(true); // 🌀 Start showing loading spinner\n\n    try {\n      const generatedImages = await callImageGenerator(refinedPrompt, 'test-user', 1);\n      navigate('/case-generated', {\n        state: {\n          productType: state.productType,\n          prompt: state.prompt,\n          boostedPrompt: refinedPrompt,\n          baseImage: baseImage,\n          referenceImage: referenceImage,\n          generatedImages: generatedImages\n        }\n      });\n    } catch (error) {\n      console.error('Error during generation:', error);\n      alert('生成失敗，請稍後重試');\n    } finally {\n      setIsGenerating(false); // 🛑 Stop loading spinner when done\n    }\n  };\n\n  // 在 AI 優化後提示詞部分之後添加手動重新優化的功能\n  const handleReoptimizePrompt = async () => {\n    setLoading(true);\n    try {\n      const boostedPrompt = await callPromptBooster(state.prompt);\n      setRefinedPrompt(boostedPrompt);\n    } catch (error) {\n      console.error('Error optimizing prompt:', error);\n      setRefinedPrompt(state.prompt); // 失敗時使用原始提示詞\n    } finally {\n      setLoading(false);\n    }\n  };\n  if (!(state !== null && state !== void 0 && state.prompt)) {\n    return null;\n  }\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"flex flex-col min-h-screen\",\n    children: /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"flex flex-grow\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"w-1/2 bg-purple-600 p-8 overflow-y-auto\",\n        children: [/*#__PURE__*/_jsxDEV(\"h1\", {\n          className: \"text-3xl font-bold mb-8 text-white\",\n          children: \"Prompt Preview\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 665,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"mb-8\",\n          children: [/*#__PURE__*/_jsxDEV(\"h2\", {\n            className: \"text-xl font-bold mb-4 text-white\",\n            children: \"\\u539F\\u59CB\\u63D0\\u793A\\u8A5E\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 668,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n            className: \"text-white mb-6 p-4 bg-purple-700 bg-opacity-50 rounded-lg\",\n            children: state.prompt\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 669,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 667,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"mb-8\",\n          children: [/*#__PURE__*/_jsxDEV(\"h2\", {\n            className: \"text-xl font-bold mb-4 text-white\",\n            children: \"AI \\u512A\\u5316\\u5F8C \\u63D0\\u793A\\u8A5E\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 673,\n            columnNumber: 13\n          }, this), loading ? /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"flex items-center space-x-2\",\n            children: [/*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"animate-spin rounded-full h-5 w-5 border-b-2 border-white\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 676,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n              className: \"text-white\",\n              children: \"\\u6B63\\u5728\\u512A\\u5316\\u4E2D...\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 677,\n              columnNumber: 17\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 675,\n            columnNumber: 15\n          }, this) : /*#__PURE__*/_jsxDEV(\"p\", {\n            className: \"text-white p-4 bg-purple-700 bg-opacity-50 rounded-lg\",\n            children: refinedPrompt\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 680,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 672,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"text-center\",\n          children: /*#__PURE__*/_jsxDEV(\"button\", {\n            onClick: handleReoptimizePrompt,\n            disabled: loading,\n            className: \"bg-white hover:bg-gray-100 text-purple-700 font-bold py-2 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\",\n            children: loading ? \"優化中...\" : \"重新優化提示詞\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 686,\n            columnNumber: 13\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 685,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"mt-8 text-center\",\n          children: /*#__PURE__*/_jsxDEV(\"button\", {\n            onClick: handleBackToPrompt,\n            className: \"bg-white hover:bg-gray-100 text-purple-700 font-bold py-2 px-6 rounded-lg transition-colors\",\n            children: \"\\u8FD4\\u56DE\\u63D0\\u793A\\u8A5E\\u7DE8\\u8F2F\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 697,\n            columnNumber: 13\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 696,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 664,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"w-1/2 bg-white p-8 overflow-y-auto\",\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"mb-6\",\n          children: [/*#__PURE__*/_jsxDEV(\"h2\", {\n            className: \"text-2xl font-bold mb-4\",\n            children: \"Base Image\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 710,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"border border-gray-200 rounded-lg p-4 flex items-center justify-center\",\n            children: baseImage || localStorage.getItem('selectedBaseImageUrl') ? /*#__PURE__*/_jsxDEV(\"img\", {\n              src: baseImage || localStorage.getItem('selectedBaseImageUrl') || '',\n              alt: \"\\u57FA\\u790E\\u5716\\u7247\",\n              className: \"max-h-64 max-w-full object-contain\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 713,\n              columnNumber: 15\n            }, this) : /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"bg-gray-100 h-64 w-full flex items-center justify-center rounded-lg\",\n              children: /*#__PURE__*/_jsxDEV(\"p\", {\n                className: \"text-gray-500\",\n                children: \"\\u7121\\u57FA\\u790E\\u5716\\u7247\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 720,\n                columnNumber: 17\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 719,\n              columnNumber: 15\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 711,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 709,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"mb-6\",\n          children: [/*#__PURE__*/_jsxDEV(\"h2\", {\n            className: \"text-2xl font-bold mb-4\",\n            children: \"Reference Image\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 729,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"border border-gray-200 rounded-lg p-4 flex items-center justify-center\",\n            children: referenceImage ? /*#__PURE__*/_jsxDEV(\"img\", {\n              src: referenceImage,\n              alt: \"\\u53C3\\u8003\\u5716\\u7247\",\n              className: \"max-h-64 max-w-full\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 732,\n              columnNumber: 17\n            }, this) : /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"bg-gray-100 h-32 w-full flex items-center justify-center rounded-lg\",\n              children: /*#__PURE__*/_jsxDEV(\"p\", {\n                className: \"text-gray-500\",\n                children: \"\\u7121\\u53C3\\u8003\\u5716\\u7247\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 735,\n                columnNumber: 19\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 734,\n              columnNumber: 17\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 730,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 728,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"mb-8\",\n          children: [/*#__PURE__*/_jsxDEV(\"h2\", {\n            className: \"text-lg font-bold mb-2\",\n            children: \"Files from Coolermaster's Database\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 743,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"ul\", {\n            className: \"list-disc pl-5\",\n            children: /*#__PURE__*/_jsxDEV(\"li\", {\n              children: \"Files from Coolermaster's Database\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 745,\n              columnNumber: 15\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 744,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 742,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"text-center\",\n          children: /*#__PURE__*/_jsxDEV(\"button\", {\n            onClick: handleContinue,\n            disabled: isGenerating // 🛑 Disable button while generating\n            ,\n            className: \"bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-12 rounded-lg text-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed\",\n            children: [isGenerating ? '生成中...' : '繼續', \"  \"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 762,\n            columnNumber: 15\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 761,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 707,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 662,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 661,\n    columnNumber: 5\n  }, this);\n};\n_s(Generator, \"W3OE+kut/hPx3RmJdWWiwh5RC/k=\", false, function () {\n  return [useLocation, useNavigate];\n});\n_c = Generator;\nexport default Generator;\nvar _c;\n$RefreshReg$(_c, \"Generator\");","map":{"version":3,"names":["React","useState","useEffect","useRef","useLocation","useNavigate","jsxDEV","_jsxDEV","SelectionTool","callPromptBooster","promptText","response","fetch","method","headers","body","JSON","stringify","user_prompt","inspiration_image_ids","use_trends","data","json","console","log","boostedPrompt","boosted_prompt","error","enhancedPrompt","callImageGenerator","userId","roundId","prompt","user_id","generation_round","generated_images","Generator","_s","location","navigate","state","isGenerating","setIsGenerating","refinedPrompt","setRefinedPrompt","loading","setLoading","selectedImage","setSelectedImage","showMindmapButton","setShowMindmapButton","canvasRef","imageRef","activeTool","setActiveTool","NONE","isSelecting","setIsSelecting","selectionArea","setSelectionArea","startPoint","setStartPoint","lassoPoints","setLassoPoints","editingPrompt","setEditingPrompt","isProcessing","setIsProcessing","baseImage","referenceImage","mockImages","storedState","localStorage","getItem","parsedState","parse","pathname","replace","setItem","current","loadImageToCanvas","src","canvas","ctx","getContext","img","Image","crossOrigin","onload","width","height","clearRect","drawImage","handleImageSelect","imageUrl","handleBackToPrompt","productType","handleViewMindmap","initialPrompt","handleMouseDown","e","rect","getBoundingClientRect","x","clientX","left","y","clientY","top","LASSO","handleMouseMove","RECTANGLE","drawSelectionPreview","type","newPoints","drawLassoPreview","handleMouseUp","length","closedPoints","Math","min","map","p","points","redrawCanvas","selection","strokeStyle","lineWidth","setLineDash","strokeRect","fillStyle","fillRect","beginPath","moveTo","i","lineTo","stroke","fill","cancelSelection","getSelectionImageData","getImageData","tempCanvas","document","createElement","tempCtx","minX","minY","maxX","max","maxY","closePath","clip","handleEdit","trim","imageData","putImageData","base64Image","toDataURL","Promise","resolve","setTimeout","editedImageData","simpleImageEdit","applyEditedImage","alert","slice","newImageData","ImageData","Uint8ClampedArray","save","restore","updateCurrentImage","handleContinue","generatedImages","handleReoptimizePrompt","className","children","fileName","_jsxFileName","lineNumber","columnNumber","onClick","disabled","alt","_c","$RefreshReg$"],"sources":["C:/Users/User/Desktop/雲湧智生/happysing_aws/frontend/src/pages/Generator.tsx"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\r\nimport { useLocation, useNavigate } from 'react-router-dom';\r\nimport './Home.css'; // Import gradient styles\r\nimport { LightBulbIcon } from '@heroicons/react/24/outline';\r\n\r\n// 定义选择工具类型\r\nenum SelectionTool {\r\n  RECTANGLE = 'rectangle',\r\n  LASSO = 'lasso',\r\n  NONE = 'none'\r\n}\r\n\r\n// 定义选择区域的接口\r\ninterface SelectionArea {\r\n  x: number;\r\n  y: number;\r\n  width?: number;\r\n  height?: number;\r\n  points?: {x: number, y: number}[];\r\n  type: SelectionTool;\r\n}\r\n\r\ninterface LocationState {\r\n  productType: string;\r\n  prompt: string;\r\n  boostedPrompt?: string;\r\n  baseImage?: string | null;\r\n  referenceImage?: string | null;\r\n}\r\n\r\nasync function callPromptBooster(promptText: string): Promise<string> {\r\n  try {\r\n    const response = await fetch('https://409etc6v1f.execute-api.us-west-2.amazonaws.com/promptbooster', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        user_prompt: promptText,\r\n        inspiration_image_ids: [],\r\n        use_trends: true\r\n      })\r\n    });\r\n\r\n    const data = await response.json();\r\n    console.log('[DEBUG] API Response:', data);  // 便於調試 API 響應\r\n    \r\n    const boostedPrompt = data.boosted_prompt;   // 直接獲取 boosted_prompt，不需要 JSON.parse(data.body)\r\n    \r\n    return boostedPrompt;\r\n  } catch (error) {\r\n    console.log('Prompt booster API failed, using fallback enhancement:', error);\r\n    \r\n    // 失敗時的備用方案\r\n    const enhancedPrompt = `${promptText}\\n\\n額外考慮要點：\r\n- 散熱效能最佳化\r\n- 材質選擇與工藝品質\r\n- 噪音控制\r\n- 安裝便利性\r\n- 美觀設計\r\n- 兼容性與未來擴充`;\r\n\r\n    return enhancedPrompt;\r\n  }\r\n}\r\n\r\nasync function callImageGenerator(promptText: string, userId: string, roundId: number): Promise<string[]> {\r\n  try {\r\n    const response = await fetch('https://409etc6v1f.execute-api.us-west-2.amazonaws.com/imagegenerator', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        prompt: promptText,\r\n        user_id: userId,\r\n        generation_round: roundId\r\n      })\r\n    });\r\n\r\n    const data = await response.json();\r\n    return data.generated_images;  // <-- array of image URLs\r\n  } catch (error) {\r\n    console.error('Image generation failed:', error);\r\n    return [];  // fallback\r\n  }\r\n}\r\n\r\n\r\nconst Generator: React.FC = () => {\r\n  const location = useLocation();\r\n  const navigate = useNavigate();\r\n  const state = location.state as LocationState;\r\n  const [isGenerating, setIsGenerating] = useState<boolean>(false);\r\n\r\n  const [refinedPrompt, setRefinedPrompt] = useState<string>('');\r\n  const [loading, setLoading] = useState<boolean>(true);\r\n  const [selectedImage, setSelectedImage] = useState<string>('');\r\n  const [showMindmapButton, setShowMindmapButton] = useState<boolean>(false);\r\n  \r\n  // Canvas相关状态\r\n  const canvasRef = useRef<HTMLCanvasElement>(null);\r\n  const imageRef = useRef<HTMLImageElement | null>(null);\r\n  const [activeTool, setActiveTool] = useState<SelectionTool>(SelectionTool.NONE);\r\n  const [isSelecting, setIsSelecting] = useState<boolean>(false);\r\n  const [selectionArea, setSelectionArea] = useState<SelectionArea | null>(null);\r\n  const [startPoint, setStartPoint] = useState<{x: number, y: number} | null>(null);\r\n  const [lassoPoints, setLassoPoints] = useState<{x: number, y: number}[]>([]);\r\n  const [editingPrompt, setEditingPrompt] = useState<string>('');\r\n  const [isProcessing, setIsProcessing] = useState<boolean>(false);\r\n\r\n  // 獲取用戶上傳的圖片\r\n  const baseImage = state?.baseImage || null;\r\n  const referenceImage = state?.referenceImage || null;\r\n\r\n  // Mock images for demonstration\r\n  const mockImages = [\r\n    '/assets/design1.jpg',\r\n    '/assets/design1.jpg',\r\n    '/assets/design1.jpg'\r\n  ];\r\n\r\n  useEffect(() => {\r\n    if (!state?.prompt) {\r\n      const storedState = localStorage.getItem('generator-last-state');\r\n      if (storedState) {\r\n        try {\r\n          const parsedState = JSON.parse(storedState);\r\n          if (parsedState && parsedState.prompt) {\r\n            console.log('Restored state from localStorage:', parsedState);\r\n            navigate(location.pathname, { \r\n              state: parsedState,\r\n              replace: true \r\n            });\r\n            return;\r\n          }\r\n        } catch (error) {\r\n          console.error('Error restoring state from localStorage:', error);\r\n        }\r\n      }\r\n      console.log('No valid state found, redirecting to home');\r\n      navigate('/');\r\n      return;\r\n    }\r\n  \r\n    try {\r\n      localStorage.setItem('generator-last-state', JSON.stringify(state));\r\n    } catch (error) {\r\n      console.error('Error saving state to localStorage:', error);\r\n    }\r\n  \r\n    // 設置原始提示詞\r\n    if (state.boostedPrompt) {\r\n      setRefinedPrompt(state.boostedPrompt);\r\n    } else {\r\n      // 如果沒有已經優化的提示詞，則使用原始提示詞\r\n      setRefinedPrompt(state.prompt);\r\n    }\r\n    \r\n    setLoading(false);\r\n    setShowMindmapButton(true);\r\n  }, [state, navigate, location.pathname]);\r\n  \r\n  \r\n\r\n  // 选择图片后加载到Canvas\r\n  useEffect(() => {\r\n    if (selectedImage && canvasRef.current) {\r\n      loadImageToCanvas(selectedImage);\r\n    }\r\n  }, [selectedImage]);\r\n\r\n  // 加载图片到Canvas\r\n  const loadImageToCanvas = (src: string) => {\r\n    const canvas = canvasRef.current;\r\n    if (!canvas) return;\r\n    \r\n    const ctx = canvas.getContext('2d');\r\n    if (!ctx) return;\r\n\r\n    const img = new Image();\r\n    img.crossOrigin = 'anonymous';\r\n    img.onload = () => {\r\n      // 设置Canvas尺寸与图片一致\r\n      canvas.width = img.width;\r\n      canvas.height = img.height;\r\n      \r\n      // 清除Canvas并绘制图片\r\n      ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);\r\n      \r\n      // 保存图片引用\r\n      imageRef.current = img;\r\n    };\r\n    img.src = src;\r\n  };\r\n\r\n  const handleImageSelect = (imageUrl: string) => {\r\n    setSelectedImage(imageUrl);\r\n    // 重置选区\r\n    setSelectionArea(null);\r\n    setActiveTool(SelectionTool.NONE);\r\n  };\r\n\r\n  const handleBackToPrompt = () => {\r\n    // Navigate back to the appropriate product page based on the product type\r\n    if (state?.productType) {\r\n      navigate(`/${state.productType}`);\r\n    } else {\r\n      navigate('/');\r\n    }\r\n  };\r\n\r\n  const handleViewMindmap = () => {\r\n    navigate('/mindmap', { \r\n      state: { \r\n        productType: state?.productType || 'cooler',\r\n        initialPrompt: state?.prompt\r\n      }\r\n    });\r\n  };\r\n\r\n  // Canvas 鼠标事件处理\r\n  const handleMouseDown = (e: React.MouseEvent<HTMLCanvasElement>) => {\r\n    if (activeTool === SelectionTool.NONE || !canvasRef.current) return;\r\n    \r\n    setIsSelecting(true);\r\n    \r\n    const canvas = canvasRef.current;\r\n    const rect = canvas.getBoundingClientRect();\r\n    const x = e.clientX - rect.left;\r\n    const y = e.clientY - rect.top;\r\n    \r\n    setStartPoint({ x, y });\r\n    \r\n    if (activeTool === SelectionTool.LASSO) {\r\n      setLassoPoints([{ x, y }]);\r\n    }\r\n  };\r\n\r\n  const handleMouseMove = (e: React.MouseEvent<HTMLCanvasElement>) => {\r\n    if (!isSelecting || !canvasRef.current || !startPoint) return;\r\n    \r\n    const canvas = canvasRef.current;\r\n    const rect = canvas.getBoundingClientRect();\r\n    const x = e.clientX - rect.left;\r\n    const y = e.clientY - rect.top;\r\n    \r\n    if (activeTool === SelectionTool.RECTANGLE) {\r\n      drawSelectionPreview({\r\n        x: startPoint.x,\r\n        y: startPoint.y,\r\n        width: x - startPoint.x,\r\n        height: y - startPoint.y,\r\n        type: SelectionTool.RECTANGLE\r\n      });\r\n    } else if (activeTool === SelectionTool.LASSO) {\r\n      const newPoints = [...lassoPoints, { x, y }];\r\n      setLassoPoints(newPoints);\r\n      drawLassoPreview(newPoints);\r\n    }\r\n  };\r\n\r\n  const handleMouseUp = (e: React.MouseEvent<HTMLCanvasElement>) => {\r\n    if (!isSelecting || !canvasRef.current || !startPoint) return;\r\n    \r\n    setIsSelecting(false);\r\n    \r\n    const canvas = canvasRef.current;\r\n    const rect = canvas.getBoundingClientRect();\r\n    const x = e.clientX - rect.left;\r\n    const y = e.clientY - rect.top;\r\n    \r\n    if (activeTool === SelectionTool.RECTANGLE) {\r\n      setSelectionArea({\r\n        x: startPoint.x,\r\n        y: startPoint.y,\r\n        width: x - startPoint.x,\r\n        height: y - startPoint.y,\r\n        type: SelectionTool.RECTANGLE\r\n      });\r\n    } else if (activeTool === SelectionTool.LASSO && lassoPoints.length > 2) {\r\n      // 闭合套索\r\n      const closedPoints = [...lassoPoints, lassoPoints[0]];\r\n      setLassoPoints(closedPoints);\r\n      setSelectionArea({\r\n        x: Math.min(...closedPoints.map(p => p.x)),\r\n        y: Math.min(...closedPoints.map(p => p.y)),\r\n        points: closedPoints,\r\n        type: SelectionTool.LASSO\r\n      });\r\n    }\r\n    \r\n    redrawCanvas();\r\n  };\r\n\r\n  // 绘制矩形选择预览\r\n  const drawSelectionPreview = (selection: SelectionArea) => {\r\n    const canvas = canvasRef.current;\r\n    if (!canvas || !selection.width || !selection.height) return;\r\n    \r\n    const ctx = canvas.getContext('2d');\r\n    if (!ctx) return;\r\n    \r\n    // 重绘原图\r\n    redrawCanvas();\r\n    \r\n    // 绘制选择矩形\r\n    ctx.strokeStyle = '#ff0000';\r\n    ctx.lineWidth = 2;\r\n    ctx.setLineDash([5, 5]);\r\n    ctx.strokeRect(selection.x, selection.y, selection.width, selection.height);\r\n    \r\n    // 创建半透明遮罩\r\n    ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';\r\n    ctx.fillRect(selection.x, selection.y, selection.width, selection.height);\r\n  };\r\n\r\n  // 绘制套索选择预览\r\n  const drawLassoPreview = (points: {x: number, y: number}[]) => {\r\n    const canvas = canvasRef.current;\r\n    if (!canvas || points.length < 2) return;\r\n    \r\n    const ctx = canvas.getContext('2d');\r\n    if (!ctx) return;\r\n    \r\n    // 重绘原图\r\n    redrawCanvas();\r\n    \r\n    // 绘制套索路径\r\n    ctx.beginPath();\r\n    ctx.moveTo(points[0].x, points[0].y);\r\n    \r\n    for (let i = 1; i < points.length; i++) {\r\n      ctx.lineTo(points[i].x, points[i].y);\r\n    }\r\n    \r\n    ctx.strokeStyle = '#ff0000';\r\n    ctx.lineWidth = 2;\r\n    ctx.setLineDash([5, 5]);\r\n    ctx.stroke();\r\n    \r\n    // 如果点足够多，填充半透明遮罩\r\n    if (points.length > 2) {\r\n      ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';\r\n      ctx.fill();\r\n    }\r\n  };\r\n\r\n  // 重绘Canvas\r\n  const redrawCanvas = () => {\r\n    const canvas = canvasRef.current;\r\n    const img = imageRef.current;\r\n    \r\n    if (!canvas || !img) return;\r\n    \r\n    const ctx = canvas.getContext('2d');\r\n    if (!ctx) return;\r\n    \r\n    // 清除画布\r\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n    \r\n    // 绘制图片\r\n    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);\r\n    \r\n    // 绘制当前选区\r\n    if (selectionArea) {\r\n      if (selectionArea.type === SelectionTool.RECTANGLE && selectionArea.width && selectionArea.height) {\r\n        ctx.strokeStyle = '#ff0000';\r\n        ctx.lineWidth = 2;\r\n        ctx.setLineDash([5, 5]);\r\n        ctx.strokeRect(selectionArea.x, selectionArea.y, selectionArea.width, selectionArea.height);\r\n        ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';\r\n        ctx.fillRect(selectionArea.x, selectionArea.y, selectionArea.width, selectionArea.height);\r\n      } else if (selectionArea.type === SelectionTool.LASSO && selectionArea.points && selectionArea.points.length > 2) {\r\n        ctx.beginPath();\r\n        ctx.moveTo(selectionArea.points[0].x, selectionArea.points[0].y);\r\n        \r\n        for (let i = 1; i < selectionArea.points.length; i++) {\r\n          ctx.lineTo(selectionArea.points[i].x, selectionArea.points[i].y);\r\n        }\r\n        \r\n        ctx.strokeStyle = '#ff0000';\r\n        ctx.lineWidth = 2;\r\n        ctx.setLineDash([5, 5]);\r\n        ctx.stroke();\r\n        ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';\r\n        ctx.fill();\r\n      }\r\n    }\r\n  };\r\n\r\n  // 取消选择\r\n  const cancelSelection = () => {\r\n    setSelectionArea(null);\r\n    setActiveTool(SelectionTool.NONE);\r\n    redrawCanvas();\r\n  };\r\n\r\n  // 获取选区图像数据\r\n  const getSelectionImageData = () => {\r\n    const canvas = canvasRef.current;\r\n    if (!canvas || !selectionArea) return null;\r\n    \r\n    const ctx = canvas.getContext('2d');\r\n    if (!ctx) return null;\r\n    \r\n    if (selectionArea.type === SelectionTool.RECTANGLE && selectionArea.width && selectionArea.height) {\r\n      // 获取矩形区域的图像数据\r\n      return ctx.getImageData(\r\n        selectionArea.x, \r\n        selectionArea.y, \r\n        selectionArea.width, \r\n        selectionArea.height\r\n      );\r\n    } else if (selectionArea.type === SelectionTool.LASSO && selectionArea.points && selectionArea.points.length > 2) {\r\n      // 对于套索，我们需要创建一个临时画布\r\n      const tempCanvas = document.createElement('canvas');\r\n      const tempCtx = tempCanvas.getContext('2d');\r\n      if (!tempCtx) return null;\r\n      \r\n      // 计算包围盒\r\n      const minX = Math.min(...selectionArea.points.map(p => p.x));\r\n      const minY = Math.min(...selectionArea.points.map(p => p.y));\r\n      const maxX = Math.max(...selectionArea.points.map(p => p.x));\r\n      const maxY = Math.max(...selectionArea.points.map(p => p.y));\r\n      \r\n      const width = maxX - minX;\r\n      const height = maxY - minY;\r\n      \r\n      tempCanvas.width = width;\r\n      tempCanvas.height = height;\r\n      \r\n      // 创建套索形状\r\n      tempCtx.beginPath();\r\n      tempCtx.moveTo(selectionArea.points[0].x - minX, selectionArea.points[0].y - minY);\r\n      \r\n      for (let i = 1; i < selectionArea.points.length; i++) {\r\n        tempCtx.lineTo(selectionArea.points[i].x - minX, selectionArea.points[i].y - minY);\r\n      }\r\n      \r\n      // 裁剪\r\n      tempCtx.closePath();\r\n      tempCtx.clip();\r\n      \r\n      // 绘制原图的选区部分\r\n      tempCtx.drawImage(canvas, \r\n        minX, minY, width, height,  // 源矩形\r\n        0, 0, width, height         // 目标矩形\r\n      );\r\n      \r\n      // 获取图像数据\r\n      return tempCtx.getImageData(0, 0, width, height);\r\n    }\r\n    \r\n    return null;\r\n  };\r\n\r\n  // 处理编辑操作\r\n  const handleEdit = async () => {\r\n    if (!selectionArea || !editingPrompt.trim()) return;\r\n    \r\n    setIsProcessing(true);\r\n    \r\n    // 获取选区图像数据\r\n    const imageData = getSelectionImageData();\r\n    if (!imageData) {\r\n      setIsProcessing(false);\r\n      return;\r\n    }\r\n    \r\n    // 将图像数据转为 Base64\r\n    const tempCanvas = document.createElement('canvas');\r\n    tempCanvas.width = imageData.width;\r\n    tempCanvas.height = imageData.height;\r\n    \r\n    const tempCtx = tempCanvas.getContext('2d');\r\n    if (!tempCtx) {\r\n      setIsProcessing(false);\r\n      return;\r\n    }\r\n    \r\n    tempCtx.putImageData(imageData, 0, 0);\r\n    const base64Image = tempCanvas.toDataURL('image/png');\r\n    \r\n    try {\r\n      // 模拟AI处理\r\n      console.log(`处理图像编辑，提示词：\"${editingPrompt}\"`);\r\n      console.log('选区信息:', selectionArea);\r\n      console.log('图像数据宽度:', imageData.width, '高度:', imageData.height);\r\n      \r\n      // 模拟API调用\r\n      await new Promise(resolve => setTimeout(resolve, 2000));\r\n      \r\n      // 在实际应用中，这里会向后端API发送请求\r\n      // const response = await fetch('/api/edit-image', {\r\n      //   method: 'POST',\r\n      //   headers: { 'Content-Type': 'application/json' },\r\n      //   body: JSON.stringify({\r\n      //     image: base64Image,\r\n      //     prompt: editingPrompt,\r\n      //     selectionType: selectionArea.type\r\n      //   })\r\n      // });\r\n      // const result = await response.json();\r\n      // const editedImageBase64 = result.editedImage;\r\n      \r\n      // 假设这是处理后的图像结果(模拟)\r\n      // 为了演示，我们在这里简单修改原图像数据（增加亮度）\r\n      const editedImageData = simpleImageEdit(imageData);\r\n      \r\n      // 应用编辑后的图像\r\n      applyEditedImage(editedImageData);\r\n      \r\n      // 清除选区\r\n      setSelectionArea(null);\r\n      setEditingPrompt('');\r\n      \r\n      alert('图像编辑完成！');\r\n    } catch (error) {\r\n      console.error('图像编辑失败:', error);\r\n      alert('图像编辑失败，请重试');\r\n    } finally {\r\n      setIsProcessing(false);\r\n    }\r\n  };\r\n\r\n  // 简单的图像编辑模拟（增加亮度）\r\n  const simpleImageEdit = (imageData: ImageData) => {\r\n    const data = imageData.data.slice();\r\n    \r\n    // 增加亮度（简单处理）\r\n    for (let i = 0; i < data.length; i += 4) {\r\n      data[i] = Math.min(255, data[i] + 50);       // R\r\n      data[i + 1] = Math.min(255, data[i + 1] + 50); // G\r\n      data[i + 2] = Math.min(255, data[i + 2] + 50); // B\r\n    }\r\n    \r\n    const newImageData = new ImageData(\r\n      new Uint8ClampedArray(data), \r\n      imageData.width, \r\n      imageData.height\r\n    );\r\n    \r\n    return newImageData;\r\n  };\r\n\r\n  // 将编辑后的图像应用到原画布\r\n  const applyEditedImage = (editedImageData: ImageData) => {\r\n    const canvas = canvasRef.current;\r\n    if (!canvas || !selectionArea) return;\r\n    \r\n    const ctx = canvas.getContext('2d');\r\n    if (!ctx) return;\r\n    \r\n    if (selectionArea.type === SelectionTool.RECTANGLE && selectionArea.width && selectionArea.height) {\r\n      // 直接将编辑后的图像数据放回原位置\r\n      ctx.putImageData(\r\n        editedImageData, \r\n        selectionArea.x, \r\n        selectionArea.y\r\n      );\r\n    } else if (selectionArea.type === SelectionTool.LASSO && selectionArea.points && selectionArea.points.length > 2) {\r\n      // 对于套索，需要使用临时画布\r\n      const minX = Math.min(...selectionArea.points.map(p => p.x));\r\n      const minY = Math.min(...selectionArea.points.map(p => p.y));\r\n      \r\n      const tempCanvas = document.createElement('canvas');\r\n      tempCanvas.width = editedImageData.width;\r\n      tempCanvas.height = editedImageData.height;\r\n      \r\n      const tempCtx = tempCanvas.getContext('2d');\r\n      if (!tempCtx) return;\r\n      \r\n      // 放置编辑后的图像数据\r\n      tempCtx.putImageData(editedImageData, 0, 0);\r\n      \r\n      // 保存当前画布状态\r\n      ctx.save();\r\n      \r\n      // 创建剪切路径\r\n      ctx.beginPath();\r\n      ctx.moveTo(selectionArea.points[0].x, selectionArea.points[0].y);\r\n      \r\n      for (let i = 1; i < selectionArea.points.length; i++) {\r\n        ctx.lineTo(selectionArea.points[i].x, selectionArea.points[i].y);\r\n      }\r\n      \r\n      ctx.closePath();\r\n      ctx.clip();\r\n      \r\n      // 绘制编辑后的图像\r\n      ctx.drawImage(\r\n        tempCanvas, \r\n        0, 0, tempCanvas.width, tempCanvas.height,\r\n        minX, minY, tempCanvas.width, tempCanvas.height\r\n      );\r\n      \r\n      // 恢复画布状态\r\n      ctx.restore();\r\n    }\r\n    \r\n    // 更新当前图像\r\n    updateCurrentImage();\r\n  };\r\n\r\n  // 更新当前图像引用\r\n  const updateCurrentImage = () => {\r\n    const canvas = canvasRef.current;\r\n    if (!canvas) return;\r\n    \r\n    const img = new Image();\r\n    img.src = canvas.toDataURL('image/png');\r\n    img.onload = () => {\r\n      imageRef.current = img;\r\n    };\r\n  };\r\n\r\n  // 處理繼續按鈕點擊\r\n  const handleContinue = async () => {\r\n    setIsGenerating(true);  // 🌀 Start showing loading spinner\r\n  \r\n    try {\r\n      const generatedImages = await callImageGenerator(refinedPrompt, 'test-user', 1);\r\n  \r\n      navigate('/case-generated', { \r\n        state: { \r\n          productType: state.productType,\r\n          prompt: state.prompt,\r\n          boostedPrompt: refinedPrompt,\r\n          baseImage: baseImage,\r\n          referenceImage: referenceImage,\r\n          generatedImages: generatedImages\r\n        } \r\n      });\r\n    } catch (error) {\r\n      console.error('Error during generation:', error);\r\n      alert('生成失敗，請稍後重試');\r\n    } finally {\r\n      setIsGenerating(false);  // 🛑 Stop loading spinner when done\r\n    }\r\n  };\r\n  \r\n  \r\n\r\n  // 在 AI 優化後提示詞部分之後添加手動重新優化的功能\r\n  const handleReoptimizePrompt = async () => {\r\n    setLoading(true);\r\n    try {\r\n      const boostedPrompt = await callPromptBooster(state.prompt);\r\n      setRefinedPrompt(boostedPrompt);\r\n    } catch (error) {\r\n      console.error('Error optimizing prompt:', error);\r\n      setRefinedPrompt(state.prompt); // 失敗時使用原始提示詞\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  if (!state?.prompt) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex flex-col min-h-screen\">\r\n      <div className=\"flex flex-grow\">\r\n        {/* 左側部分 - 提示詞 */}\r\n        <div className=\"w-1/2 bg-purple-600 p-8 overflow-y-auto\">\r\n          <h1 className=\"text-3xl font-bold mb-8 text-white\">Prompt Preview</h1>\r\n          \r\n          <div className=\"mb-8\">\r\n            <h2 className=\"text-xl font-bold mb-4 text-white\">原始提示詞</h2>\r\n            <p className=\"text-white mb-6 p-4 bg-purple-700 bg-opacity-50 rounded-lg\">{state.prompt}</p>\r\n          </div>\r\n          \r\n          <div className=\"mb-8\">\r\n            <h2 className=\"text-xl font-bold mb-4 text-white\">AI 優化後 提示詞</h2>\r\n            {loading ? (\r\n              <div className=\"flex items-center space-x-2\">\r\n                <div className=\"animate-spin rounded-full h-5 w-5 border-b-2 border-white\"></div>\r\n                <p className=\"text-white\">正在優化中...</p>\r\n              </div>\r\n            ) : (\r\n              <p className=\"text-white p-4 bg-purple-700 bg-opacity-50 rounded-lg\">{refinedPrompt}</p>\r\n            )}\r\n          </div>\r\n          \r\n          {/* 手動重新優化提示詞按鈕 */}\r\n          <div className=\"text-center\">\r\n            <button\r\n              onClick={handleReoptimizePrompt}\r\n              disabled={loading}\r\n              className=\"bg-white hover:bg-gray-100 text-purple-700 font-bold py-2 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              {loading ? \"優化中...\" : \"重新優化提示詞\"}\r\n            </button>\r\n          </div>\r\n\r\n          {/* 添加返回按鈕替代導航欄 */}\r\n          <div className=\"mt-8 text-center\">\r\n            <button \r\n              onClick={handleBackToPrompt}\r\n              className=\"bg-white hover:bg-gray-100 text-purple-700 font-bold py-2 px-6 rounded-lg transition-colors\"\r\n            >\r\n              返回提示詞編輯\r\n            </button>\r\n          </div>\r\n        </div>\r\n        \r\n        {/* 右側部分 - 圖片 */}\r\n        <div className=\"w-1/2 bg-white p-8 overflow-y-auto\">\r\n          {/* Base Image 部分 */}\r\n          <div className=\"mb-6\">\r\n            <h2 className=\"text-2xl font-bold mb-4\">Base Image</h2>\r\n            <div className=\"border border-gray-200 rounded-lg p-4 flex items-center justify-center\">\r\n            {(baseImage || localStorage.getItem('selectedBaseImageUrl')) ? (\r\n              <img\r\n                src={baseImage || localStorage.getItem('selectedBaseImageUrl') || ''}\r\n                alt=\"基礎圖片\"\r\n                className=\"max-h-64 max-w-full object-contain\"\r\n              />\r\n            ) : (\r\n              <div className=\"bg-gray-100 h-64 w-full flex items-center justify-center rounded-lg\">\r\n                <p className=\"text-gray-500\">無基礎圖片</p>\r\n              </div>\r\n            )}\r\n\r\n            </div>\r\n          </div>\r\n          \r\n          {/* Reference Image 部分 */}\r\n          <div className=\"mb-6\">\r\n            <h2 className=\"text-2xl font-bold mb-4\">Reference Image</h2>\r\n            <div className=\"border border-gray-200 rounded-lg p-4 flex items-center justify-center\">\r\n              {referenceImage ? (\r\n                <img src={referenceImage} alt=\"參考圖片\" className=\"max-h-64 max-w-full\" />\r\n              ) : (\r\n                <div className=\"bg-gray-100 h-32 w-full flex items-center justify-center rounded-lg\">\r\n                  <p className=\"text-gray-500\">無參考圖片</p>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n          \r\n          {/* Files from Coolermaster's Database */}\r\n          <div className=\"mb-8\">\r\n            <h2 className=\"text-lg font-bold mb-2\">Files from Coolermaster's Database</h2>\r\n            <ul className=\"list-disc pl-5\">\r\n              <li>Files from Coolermaster's Database</li>\r\n            </ul>\r\n          </div>\r\n          \r\n          {/* 模擬圖片展示區\r\n          <div className=\"mb-6\">\r\n            <div className=\"grid grid-cols-3 gap-4\">\r\n              {mockImages.map((img, index) => (\r\n                <div key={index} className=\"border border-gray-200 rounded-lg overflow-hidden\">\r\n                  <img src={img} alt={`設計 ${index + 1}`} className=\"w-full h-32 object-cover\" />\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </div> */}\r\n          \r\n          {/* 繼續按鈕 */}\r\n          <div className=\"text-center\">\r\n              <button \r\n                onClick={handleContinue}\r\n                disabled={isGenerating}  // 🛑 Disable button while generating\r\n                className=\"bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-12 rounded-lg text-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\r\n              >\r\n                {isGenerating ? '生成中...' : '繼續'}  {/* 🌀 Change button text */}\r\n              </button>\r\n\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Generator;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}